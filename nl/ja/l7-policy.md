---

copyright:
  years: 2017, 2018
lastupdated: "2018-11-12"

keywords: l7, layer 7, policy, policies

subcollection: loadbalancer-service

---

{:shortdesc: .shortdesc}
{:codeblock: .codeblock}
{:screen: .screen}
{:new_window: target="_blank"}
{:pre: .pre}
{:table: .aria-labeledby="caption"}
{:note: .note}
{:important: .important}
{:tip: .tip}

# レイヤー 7 ポリシー
{: #layer-7-policy}

レイヤー 7 (L7) ポリシーはトラフィックを分類するために使用されます。そのために、トラフィックの L7 情報と L7 ルールとの突き合わせが行われ、それらのルールが一致した場合は特定のアクションが実行されます。

* ポリシーは、フロントエンド・アプリケーション・ポート (プロトコル) に適用されます。
* 複数のポリシーを同じプロトコルに適用することが可能です。

複数のポリシーを 1 つのプロトコルに適用することが可能であるため、各ポリシーには優先順位が関連付けられます。

* 最も優先順位の低いポリシーが設定されているポリシーが最初に評価されます。
* そのポリシーに関連付けられたルールがトラフィックと一致しない場合、優先順位リストの中で次に低いポリシーが評価されます。

トラフィックがどのポリシー・ルールにも一致しない場合、トラフィックは基本ロード・バランサーのデプロイ時に構成されたデフォルト・プールに転送されます。

各ポリシーには、ポリシー内のすべてのルールがトラフィックと一致した場合に実行されるアクションが関連付けられます。

アクションには次のものがあります。

- 拒否
- URL への転送
- プールへの転送

優先順位に関係なく、`reject` に設定されたポリシーが最初に評価されます。

その後、`redirect to url` に設定されたポリシーが評価されます。

最後に、`redirect to pool` に設定されたポリシーが評価されます。

各アクション・カテゴリー内では、ポリシーは優先順位の昇順に (最低から最高への順に) 評価されます。

## レイヤー 7 ポリシーのプロパティー
{: #layer-7-policy-properties}

プロパティー  | 説明
------------- | -------------
名前 | ポリシーの名前。 各ポリシーの名前は固有でなければなりません。
アクション | ルールが一致した場合に実行されるアクション。 アクションは、`REJECT`、`REDIRECT_URL`、および `REDIRECT_POOL` です。 優先順位に関係なく、アクションが `REJECT` に設定されたポリシーが常に最初に評価されます。 次に、アクションが `REDIRECT_URL` に設定されたポリシーが評価され、アクションが `REDIRECT_POOL` に設定されたポリシーはその後になります。
優先順位 | ポリシーは、優先順位の昇順に基づいて評価されます。
リダイレクト URL | アクションが `REDIRECT_URL` に設定されている場合にトラフィックが転送される先の URL。
リダイレクト L7 プール | アクションが `REDIRECT_POOL` に設定されている場合にトラフィックが送信される先のサーバー・プール。
プロトコル | ポリシーが適用されるフロントエンド・アプリケーション・ポート。

## レイヤー 7 ルール
{: #layer-7-rule}
レイヤー 7 ルールは、着信トラフィックのどの部分を特定の値と突き合わせるのかを定義します。

* 着信トラフィックがルールの指定値と一致する場合、そのルールは `true` と評価されます。
* レイヤー 7 ルールは、必ずレイヤー 7 ポリシーと関連付けられています。 複数のレイヤー 7 ルールを同じレイヤー 7 ポリシーに関連付けることができます。
* 複数のルールが 1 つのポリシーに関連付けられている場合、各ルールが `true` または `false` と評価されます。
* ポリシーに関連付けられているすべてのルールが `true` と評価されると、そのポリシーのアクションが要求に適用されます。 それ以外の場合、ロード・バランサーは次のポリシーを評価します。

ルールには、次のタイプがあります。

* `HOST_NAME`
* `FILE_TYPE`
* `HEADER`
* `COOKIE`
* `PATH`

これらは、レイヤー 7 トラフィックのどの部分がルールと突き合わせられるのかを示します。

タイプ      |  抽出および評価されるフィールド
----------| -----------------------
`HOST_NAME` | URL のホスト名の部分 (例: `api.my_company.com`)
`FILE_TYPE` | ファイル・タイプを表す、URL の末尾 (例: `jpg`)
HEADER    | HTTP ヘッダー内のフィールド
COOKIE    | HTTP ヘッダー内の名前付き Cookie 
PATH      | URL のホスト名に続く部分 (例: `/index.html`)

ルールには比較タイプもあります。これは、ルールがどのように評価されるのかを示します。
ルールの比較タイプは以下のいずれかです。

* `REGEX`
* `STARTS_WITH`
* `ENDS_WITH`
* `CONTAINS`
* `EQUAL_TO`

比較タイプ |  評価のタイプ
----------------|---------------------
`REGEX`           |  抽出されたフィールド (例: `hostname`) を、指定された正規表現と突き合わせます
`STARTS_WITH`     |  抽出されたフィールドが指定されたストリングで始まっているかどうかを検証します
`ENDS_WITH`       |  抽出されたフィールドが指定されたストリングで終わっているかどうかを検証します
`CONTAINS`        |  抽出されたフィールドが指定されたストリングを含んでいるかどうかを検証します
`EQUAL_TO`        |  抽出されたフィールドが指定されたストリングと同一かどうかを検証します

すべてのルール・タイプがすべての比較タイプをサポートしているわけではありません。例えば、`FILE_TYPE` を使用する場合は、比較タイプ `REGEX` および `ENDS_WITH` を使用するのが最適です。
{: tip}

## レイヤー 7 ルールのプロパティー
{: #layer-7-rule-properties}

プロパティー  | 説明
------------- | -------------
タイプ (Type) | ルールのタイプを指定します。 指定できるルール・タイプは、`HOST_NAME` (ホストの名前)、`FILE_TYPE` (ファイルのタイプ)、`HEADER` (ヘッダー)、`COOKIE` (Cookie)、または `PATH` (パス) です。
比較タイプ | 比較タイプは、ルールを定義してトラフィックを分類するために、ルール・タイプ、キー、および値と関連して使用されます。 指定できる比較タイプは、`REGEX`、`STARTS_WITH`、`ENDS_WITH`、`CONTAINS`、または `EQUAL_TO` です。
キー (Key) | ルール・タイプ `HEADER` および `COOKIE` の記述キー。
値 (Value) |  ルール・タイプ `HEADER` および `COOKIE` の場合、値がキーと比較されます。
反転 (Invert) | この値を 1 に設定すると、この L7 ルール比較の値は、指定されたルールが一致しない場合に `true` に設定されます。
レイヤー 7 ポリシー ID | ルールが関連付けられるポリシーの固有 ID。
